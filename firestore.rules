rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- Helpers ---------- */
    function signedIn() {
      return request.auth != null;
    }

    function userDocPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function userRole() {
      return (signedIn() && exists(userDocPath()))
        ? get(userDocPath()).data.role
        : null;
    }

    function owner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function pharmacyOrAdmin() {
      let r = userRole();
      return r == 'pharmacy' || r == 'admin' || r == 'superuser';
    }

    /* ---------- users + cart ---------- */
    match /users/{userId} {
      allow read: if signedIn();
      allow write: if owner(userId) || pharmacyOrAdmin();

      match /cart/{cartItemId} {
        allow read, list: if owner(userId);
        allow create: if owner(userId)
          && request.resource.data.productId is string
          && request.resource.data.qty is number
          && request.resource.data.qty > 0;

        allow update: if owner(userId)
          && request.resource.data.productId == resource.data.productId
          && request.resource.data.qty is number
          && request.resource.data.qty > 0;

        allow delete: if owner(userId);
      }
    }

    /* ---------- pharmacies ---------- */
    match /pharmacies/{pharmacyId} {
      allow read: if true;

      allow create: if pharmacyOrAdmin()
        && request.resource.data.id == request.auth.uid;

      allow update: if pharmacyOrAdmin()
        && pharmacyId == request.auth.uid
        && request.resource.data.id == resource.data.id;

      allow delete: if userRole() == 'admin' || userRole() == 'superuser';
    }

    /* ---------- products ---------- */
    match /products/{productId} {
      allow read, list: if true;

      allow create: if pharmacyOrAdmin()
        && request.resource.data.pharmacyId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.price is number
        && request.resource.data.price >= 0
        && request.resource.data.stock is number
        && request.resource.data.stock >= 0;

      allow update: if pharmacyOrAdmin()
        && resource.data.pharmacyId == request.auth.uid
        && request.resource.data.pharmacyId == resource.data.pharmacyId
        && (!('price' in request.resource.data) || (request.resource.data.price is number && request.resource.data.price >= 0))
        && (!('stock' in request.resource.data) || (request.resource.data.stock is number && request.resource.data.stock >= 0));

      allow delete: if pharmacyOrAdmin()
        && resource.data.pharmacyId == request.auth.uid;
    }

    /* ---------- orders ---------- */
    match /orders/{orderId} {
      allow read: if signedIn() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.pharmacyId == request.auth.uid ||
        userRole() == 'admin' || userRole() == 'superuser'
      );

      allow create: if signedIn()
        && request.resource.data.customerId == request.auth.uid
        && request.resource.data.pharmacyId is string
        && request.resource.data.total is number
        && request.resource.data.total >= 0
        && request.resource.data.items is list
        && request.resource.data.items.size() > 0
        && request.resource.data.status == 'placed';

      // pharmacy/admin can only change 'status' (+ optional 'updatedAt')
      // customer can do no-op updates only
      allow update: if signedIn() && (
        (
          (resource.data.pharmacyId == request.auth.uid || userRole() == 'admin' || userRole() == 'superuser')
          && request.resource.data.customerId == resource.data.customerId
          && request.resource.data.pharmacyId == resource.data.pharmacyId
          && request.resource.data.items == resource.data.items
          && request.resource.data.total == resource.data.total
          && request.resource.data.status in ['placed','processing','shipped','completed','cancelled']
        )
        ||
        (
          resource.data.customerId == request.auth.uid
          && request.resource.data == resource.data
        )
      );

      allow delete: if userRole() == 'admin' || userRole() == 'superuser';
    }
  }
}